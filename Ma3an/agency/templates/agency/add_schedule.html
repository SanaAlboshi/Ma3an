{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/agency.css' %}">

<div class="container mt-4">
    <!-- Multi Step Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center text-center">

            <div class="step {% if current_step > 1 %}completed{% endif %} {% if current_step == 1 %}active{% endif %}">
    <div class="circle">1</div>
    <small>Tour Info</small>
</div>
<div class="line {% if current_step > 1 %}completed{% endif %}"></div>

<div class="step {% if current_step > 2 %}completed{% endif %} {% if current_step == 2 %}active{% endif %}">
    <div class="circle">2</div>
    <small>Schedule</small>
</div>
<div class="line {% if current_step > 2 %}completed{% endif %}"></div>

<div class="step {% if current_step == 3 %}active{% endif %}">
    <div class="circle">3</div>
    <small>Confirm</small>
</div>

        </div>
    </div>
    
    <h1>Add Schedule for Tour: {{ tour.name }}</h1>
    
    <form method="POST">
        {% csrf_token %}
        
        {% if not days %}
        <div class="mb-3">
            <label class="form-label">Number of Days:</label>
            <input type="number" name="number_of_days" class="form-control" min="1" max="30" required>
        </div>
        <button type="submit" name="set_days" class="btn btn-primary">Next</button>
        
        {% else %}
        <input type="hidden" name="number_of_days" value="{{ number_of_days }}">
        
        {% for day in days %}
        <div class="day">
            <h3>Day {{ day }}</h3>
            <div id="activities_day_{{ day }}">
                <div class="activity">
                    <label>Start Time</label>
                    <input type="time" name="day_{{ day }}_start_time[]" class="form-control" required>
                    
                    <label>End Time</label>
                    <input type="time" name="day_{{ day }}_end_time[]" class="form-control" required>
                    
                    <label>Activity Title</label>
                    <input type="text" name="day_{{ day }}_activity_title[]" class="form-control" required>
                    
                    <label>Location Name</label>
                    <input type="text" name="day_{{ day }}_location_name[]" class="form-control">

                   <label>Latitude</label>
                   <input type="text" name="day_{{ day }}_latitude[]" class="form-control">

                   <label>Longitude</label>
                   <input type="text" name="day_{{ day }}_longitude[]" class="form-control">

                    
                    <label>Location URL</label>
                    <input type="url" name="day_{{ day }}_location_url[]" class="form-control">
                    
                    
                    <label>Description</label>
                    <textarea name="day_{{ day }}_description[]" class="form-control" rows="3"></textarea>
                    
                    <span class="remove-activity" data-remove-activity>Remove</span>
                </div>
            </div>
            <button type="button" class="btn btn-primary mt-2" data-add-activity="{{ day }}">+ Add Another Activity</button>
        </div>
        {% endfor %}
        
        <button type="submit" class="btn btn-success">Next âžœ</button>
        {% endif %}
    </form>

    <div class="mb-3 mt-3">
        <a href="{% url 'agency:dashboard' %}" class="btn btn-secondary">&larr; Back to Dashboard</a>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Schedule page loaded');
    
    // Add event listeners to all "Add Activity" buttons
    document.querySelectorAll('[data-add-activity]').forEach(button => {
        button.addEventListener('click', function() {
            const day = this.dataset.addActivity;
            console.log('Adding activity for day:', day);
            addActivity(day);
        });
    });
    
    // Add event listeners to all "Remove" buttons
    document.addEventListener('click', function(e) {
        if (e.target && e.target.hasAttribute('data-remove-activity')) {
            removeActivity(e.target);
        }
    });
});

function addActivity(day) {
    const container = document.getElementById(`activities_day_${day}`);
    if (!container) {
        console.error(`Container not found for day ${day}`);
        return;
    }
    
    const div = document.createElement("div");
    div.className = "activity";
    div.innerHTML = `
        <label>Start Time</label>
        <input type="time" name="day_${day}_start_time[]" class="form-control" required>
        
        <label>End Time</label>
        <input type="time" name="day_${day}_end_time[]" class="form-control" required>
        
        <label>Activity Title</label>
        <input type="text" name="day_${day}_activity_title[]" class="form-control" required>
        
        <label>Location Name</label>
        <input type="text" name="day_${day}_location_name[]" class="form-control">
        
        <label>Location URL</label>
        <input type="url" name="day_${day}_location_url[]" class="form-control">
        
        <label>Description</label>
        <textarea name="day_${day}_description[]" class="form-control" rows="3"></textarea>
        
        <span class="remove-activity" data-remove-activity>Remove</span>
    `;
    container.appendChild(div);
    console.log('Activity added successfully for day:', day);
}

function removeActivity(el) {
    const activityDiv = el.parentElement;
    const container = activityDiv.parentElement;
    
    // Check if this is the last activity in the day
    const activitiesCount = container.querySelectorAll('.activity').length;
    
    if (activitiesCount <= 1) {
        alert('You must have at least one activity per day!');
        return;
    }
    
    activityDiv.remove();
    console.log('Activity removed successfully');
}
</script>
{% endblock %}